(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-02361d8c"],{1424:function(e,t,s){"use strict";s.r(t);var r=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("v-main",[r("v-img",{staticClass:"bdBackground",attrs:{src:s("775a"),height:"100%",width:"100%"}}),r("v-container",[r("v-row",[r("v-col",[r("v-card",{attrs:{width:"100%",height:"500px",color:"#FFFDE7",tile:""}},[r("v-row",{staticClass:"ma-0"},[r("v-col",{staticClass:"pa-0",attrs:{cols:"3"}},[r("v-list",{staticClass:"pa-0",attrs:{color:"#FFFDE7"}},[r("v-list-item-group",[e._l(e.history,(function(t,s){return r("v-hover",{key:t.sid,scopedSlots:e._u([{key:"default",fn:function(i){var o=i.hover;return[r("v-list-item",{on:{click:function(t){return e.switchMessages(s)}}},[[r("v-list-item-avatar",[r("v-img",{attrs:{src:"http://n.sinaimg.cn/sinacn/w800h755/20171206/ef92-fypikwu3264849.png"}})],1),r("v-list-item-content",[r("v-list-item-title",[e._v(e._s(t.nickname))])],1),0!=t.unread?r("v-avatar",{attrs:{color:"red",size:"20"}},[r("span",{staticClass:"white--text"},[e._v(e._s(t.unread))])]):e._e(),o&&0!=s?r("v-icon",{on:{click:function(s){return s.stopPropagation(),e.closeHistory(t.sid)}}},[e._v("mdi-close")]):e._e()]],2)]}}],null,!0)})}))],2)],1)],1),r("v-col",{staticStyle:{height:"500px"}},[r("v-card",{attrs:{height:"100%"}},[r("v-card-title",[e._v(e._s(e.history[e.currentMessageIndex].nickname))]),r("v-divider"),r("v-card-text",{staticClass:"chat_box",staticStyle:{height:"77%",overflow:"auto"}},e._l(e.history[e.currentMessageIndex].messages,(function(t,s){return r("v-list-item",{key:s},[r("v-list-item-avatar",{directives:[{name:"show",rawName:"v-show",value:t.fromUser!=e.user.student_id,expression:"message.fromUser != user.student_id"}]},[r("v-img",{attrs:{src:e.history[e.currentMessageIndex].user_pic}})],1),r("v-list-item-content",[r("v-list-item-title",{class:{"text-right":t.fromUser==e.user.student_id}},[t.ack?e._e():r("v-progress-circular",{attrs:{indeterminate:"",color:"green",size:"25"}}),e._v(" "+e._s(t.message)+" ")],1)],1),r("v-list-item-avatar",{directives:[{name:"show",rawName:"v-show",value:t.fromUser==e.user.student_id,expression:"message.fromUser == user.student_id"}]},[r("v-img",{attrs:{src:e.user.user_pic}})],1)],1)})),1),r("v-divider"),r("v-text-field",{attrs:{placeholder:"ENTER发送消息",solo:""},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage(t)}},scopedSlots:e._u([{key:"append",fn:function(){return[r("v-btn",{attrs:{color:"success"},on:{click:e.sendMessage}},[e._v("发送")])]},proxy:!0}]),model:{value:e.message.message,callback:function(t){e.$set(e.message,"message","string"===typeof t?t.trim():t)},expression:"message.message"}})],1)],1)],1)],1)],1)],1)],1)],1)},i=[],o=s("b85c"),n=(s("4328"),s("2b0e")),a=(s("5132"),s("5831")),c={name:"chat",created:function(){1==this.$socket.disconnected&&(console.log(this.$socket),this.$socket.query="access_token="+localStorage.getItem("access_token"),this.$socket.connect(),console.log(this.$socket))},mounted:function(){var e=this,t=localStorage.getItem("user"),s=JSON.parse(t);this.user=s,this.history=JSON.parse(localStorage.getItem("history-"+this.user.id)),null==this.history&&(this.history=this.initHistory(),localStorage.setItem("history-"+this.user.id,JSON.stringify(this.history))),console.log(this.history),this.$socket.disconnected&&this.$socket.connect(),window.addEventListener("beforeunload",(function(t){return e.beforeunloadFn(t)}))},watch:{currentMessageIndex:function(){var e=this;setTimeout((function(){e.scrollToBottom()}),30)}},data:function(){return{user:{nickName:"Ikaros"},currentMessageIndex:this.$route.params.user_id?this.$route.params.user_id:0,message:{id:null,message:null,time:null,fromUser:null,toUser:this.$route.params.user_id?this.$route.params.user_id:0,read:null},history:{0:{nickName:"布叮校园",unread:0,user_pic:"https://img.shixijob.net/ciwei_ALD_sys/159119076455364ca6bc7-7dc4-4dbc-8010-ef2a73f8be61.png"}}}},sockets:{get_unread:function(e){console.log(1);var t,s=Object(o["a"])(e);try{for(s.s();!(t=s.n()).done;){var r=t.value;r.ack=!0,this.handleReceiveMessage(r)}}catch(i){s.e(i)}finally{s.f()}},receive_message:function(e){e.ack=!0,this.handleReceiveMessage(e)},sent:function(e){var t=this.history[this.currentMessageIndex];t.messages||(t.messages=[]),n["default"].set(t.messages,t.messages.length,e),this.message.message_content=""}},beforeDestroy:function(){console.log("beforeDestroy"),this.recordHistory()},destroyed:function(){var e=this;window.removeEventListener("beforeunload",(function(t){return e.beforeunloadFn(t)}))},methods:{handleReceiveMessage:function(e){var t=this;this.history[e.fromUser]?(this.history[e.fromUser].messages||(this.history[e.fromUser].messages=[]),e.id=this.history[e.fromUser].messages.length+1,delete this.history[e.fromUser].messages[void 0],this.history[e.fromUser].messages.push(e),e.fromUser!=this.currentMessageIndex&&(this.history[e.fromUser].unread=parseInt(this.history[e.fromUser].unread)+1)):(console.log("新发来消息的用户不存在于对话框"),a["a"](e.fromUser).then((function(s){s.success?n["default"].set(t.history,e.fromUser,{student_id:e.fromUser,nickName:s.data.nickName,messages:[e],user_pic:s.data.userPic,unread:1}):t.$message.error(s.message)})).catch((function(e){t.$message.error(e.message)}))),setTimeout((function(){t.scrollToBottom()}),30)},initHistory:function(){return{0:{sid:"0",nickname:"布叮校园",userPic:"http://localhost/img/logo.4a490907.png",messages:[],unread:0},17551119111:{sid:"17551119111",nickname:"17551119111",userPic:"http://localhost/img/logo.4a490907.png",messages:[],unread:0},17551119044:{sid:"17551119044",nickname:"17551119044",userPic:"http://localhost/img/logo.4a490907.png",messages:[],unread:0}}},closeHistory:function(e){this.currentMessageIndex=0,n["default"].delete(this.history,e),this.recordHistory()},beforeunloadFn:function(e){this.recordHistory()},recordHistory:function(){localStorage.setItem("history-"+this.user.id,JSON.stringify(this.history))},sendMessage:function(){var e=this;null!=this.message.message&&""!=this.message.message&&(this.message.fromUser=this.user.student_id,this.message.toUser=this.currentMessageIndex,this.message.ack=!1,this.message.id=this.history[this.currentMessageIndex].messages.length+1,this.history[this.currentMessageIndex].messages.push(JSON.parse(JSON.stringify(this.message))),this.$socket.emit("send_message",this.message,(function(t){var s,r=Object(o["a"])(e.history[t.toUser].messages);try{for(r.s();!(s=r.n()).done;){var i=s.value;if(i.id==t.id){i.ack=!0;break}}}catch(n){r.e(n)}finally{r.f()}})),this.message.message="",setTimeout((function(){e.scrollToBottom()}),30))},switchMessages:function(e){this.currentMessageIndex=e,this.history[e].unread=0},scrollToBottom:function(){var e=this.$el.querySelector(".chat_box");e&&(e.scrollTop=e.scrollHeight)}}},u=c,l=(s("ebd1"),s("2877")),d=s("6544"),h=s.n(d),m=s("8212"),f=s("8336"),g=s("b0af"),v=s("99d9"),p=s("62ad"),y=s("a523"),b=s("ce7e"),k=s("ce87"),_=s("132d"),x=s("adda"),w=s("8860"),I=s("da13"),U=s("8270"),M=s("5d23"),S=s("1baa"),$=s("f6c4"),C=s("490a"),O=s("0fd9"),T=s("8654"),V=Object(l["a"])(u,r,i,!1,null,null,null);t["default"]=V.exports;h()(V,{VAvatar:m["a"],VBtn:f["a"],VCard:g["a"],VCardText:v["b"],VCardTitle:v["c"],VCol:p["a"],VContainer:y["a"],VDivider:b["a"],VHover:k["a"],VIcon:_["a"],VImg:x["a"],VList:w["a"],VListItem:I["a"],VListItemAvatar:U["a"],VListItemContent:M["a"],VListItemGroup:S["a"],VListItemTitle:M["b"],VMain:$["a"],VProgressCircular:C["a"],VRow:O["a"],VTextField:T["a"]})},"16b7":function(e,t,s){"use strict";s("a9e3");var r=s("2b0e");t["a"]=r["default"].extend().extend({name:"delayable",props:{openDelay:{type:[Number,String],default:0},closeDelay:{type:[Number,String],default:0}},data:function(){return{openTimeout:void 0,closeTimeout:void 0}},methods:{clearDelay:function(){clearTimeout(this.openTimeout),clearTimeout(this.closeTimeout)},runDelay:function(e,t){var s=this;this.clearDelay();var r=parseInt(this["".concat(e,"Delay")],10);this["".concat(e,"Timeout")]=setTimeout(t||function(){s.isActive={open:!0,close:!1}[e]},r)}}})},5831:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var r=s("1797"),i=(s("b383"),s("6941")),o=i.systemConfig,n=o.gatewayApiUrl,a=o.bdApiUrlPre,c=function(e){return r["a"].requestGet(n+a+"/ucenter/user/simple/"+e)}},"775a":function(e,t,s){e.exports=s.p+"img/1.73686a3f.png"},"8ce9":function(e,t,s){},"91dd":function(e,t,s){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,s,o){t=t||"&",s=s||"=";var n={};if("string"!==typeof e||0===e.length)return n;var a=/\+/g;e=e.split(t);var c=1e3;o&&"number"===typeof o.maxKeys&&(c=o.maxKeys);var u=e.length;c>0&&u>c&&(u=c);for(var l=0;l<u;++l){var d,h,m,f,g=e[l].replace(a,"%20"),v=g.indexOf(s);v>=0?(d=g.substr(0,v),h=g.substr(v+1)):(d=g,h=""),m=decodeURIComponent(d),f=decodeURIComponent(h),r(n,m)?i(n[m])?n[m].push(f):n[m]=[n[m],f]:n[m]=f}return n};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},b383:function(e,t,s){"use strict";t.decode=t.parse=s("91dd"),t.encode=t.stringify=s("e099")},ce7e:function(e,t,s){"use strict";var r=s("5530"),i=(s("8ce9"),s("7560"));t["a"]=i["a"].extend({name:"v-divider",props:{inset:Boolean,vertical:Boolean},render:function(e){var t;return this.$attrs.role&&"separator"!==this.$attrs.role||(t=this.vertical?"vertical":"horizontal"),e("hr",{class:Object(r["a"])({"v-divider":!0,"v-divider--inset":this.inset,"v-divider--vertical":this.vertical},this.themeClasses),attrs:Object(r["a"])({role:"separator","aria-orientation":t},this.$attrs),on:this.$listeners})}})},ce87:function(e,t,s){"use strict";var r=s("16b7"),i=s("f2e7"),o=s("58df"),n=s("d9bd");t["a"]=Object(o["a"])(r["a"],i["a"]).extend({name:"v-hover",props:{disabled:{type:Boolean,default:!1},value:{type:Boolean,default:void 0}},methods:{onMouseEnter:function(){this.runDelay("open")},onMouseLeave:function(){this.runDelay("close")}},render:function(){return this.$scopedSlots.default||void 0!==this.value?(this.$scopedSlots.default&&(e=this.$scopedSlots.default({hover:this.isActive})),Array.isArray(e)&&1===e.length&&(e=e[0]),e&&!Array.isArray(e)&&e.tag?(this.disabled||(e.data=e.data||{},this._g(e.data,{mouseenter:this.onMouseEnter,mouseleave:this.onMouseLeave})),e):(Object(n["c"])("v-hover should only contain a single element",this),e)):(Object(n["c"])("v-hover is missing a default scopedSlot or bound value",this),null);var e}})},d0f0:function(e,t,s){},e099:function(e,t,s){"use strict";var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,s,a){return t=t||"&",s=s||"=",null===e&&(e=void 0),"object"===typeof e?o(n(e),(function(n){var a=encodeURIComponent(r(n))+s;return i(e[n])?o(e[n],(function(e){return a+encodeURIComponent(r(e))})).join(t):a+encodeURIComponent(r(e[n]))})).join(t):a?encodeURIComponent(r(a))+s+encodeURIComponent(r(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var s=[],r=0;r<e.length;r++)s.push(t(e[r],r));return s}var n=Object.keys||function(e){var t=[];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.push(s);return t}},ebd1:function(e,t,s){"use strict";s("d0f0")}}]);
//# sourceMappingURL=chunk-02361d8c.bb054fe9.js.map